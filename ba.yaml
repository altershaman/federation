functions:
  byContext:
    title: Raw distribution of objects by contexts (with no facades impressed)
    params:
      - type: object
        title: $$
        alias: ctxG
        required: true
    code: >
      (   
          $ctxG:= ctxG;
          $contexts_id:= $seaf_contexts($ctxG).context;
          
          $contexts_till_down:= $map($contexts_id, function($v) {
              {
                "context": $v,
                "content": $seaf_context_content($v, $ctxG)
                }
          });

          /*sort contexts from lowest (no other contexts inside)             */
          /*                to highest (includes max number of other contexts*/
          $contexts_id:= $contexts_till_down.context;
          $contexts_id_ordered:=
          $map($contexts_id, function($v) {(
            {$v: $count($map($contexts_id[$ != $v], function($vv) {
                          $vv in $contexts_till_down[$.context = $v].content.object_id
                            ? {$v: $vv}
                            : {$v: null}
                        })[$.* != null]
                  )
            }
          )})^(<$.*).$keys();
            
          $trim:= function($order, $i, $contexts){(
            $toTrimOff:= $contexts[$.context = $order[$i]];
            $toTrim:= $contexts[$.context !=  $order[$i]];
            $contexts:= $map($toTrim, function($v){
                          $v~>|$|{"content": $map($v.content, function($vv){(
                                                $not($vv.object_id in $toTrimOff.content.object_id) or
                                                $vv.object_id = $toTrimOff.context or
                                                $vv.object_id = $v.context
                                                  ? $vv
                                              )})
                                  }|
                        });
            $contexts:= $append($contexts, $toTrimOff);
            $i < $count($order)-1
              ? $trim($order, $i+1, $contexts)
              : $contexts
          )};
          $contexts_isolated:= $trim($contexts_id_ordered, 0, $contexts_till_down);

          $ctxG:= {
            "context": "ctxG",
            "content": 
            /*
              $append(
                [{"object_id": "ctxG", "body": {"title": "глобальный"}}],
            */
                [$distinct($contexts_isolated.content[$.object_id in $seaf_ddd_top($ctxG."seaf.ba.parties")])]
             /* )*/
            };
          $append($ctxG, $contexts_isolated)
      )

  seaf_context_content:
    title: Содержимое контекста
    params:
      - type: string
        title: Идентификатор объекта
        alias: obj_id
        required: true
      - type: object
        title: Глобальный Контекст -- $$
        alias: ctx
        required: true
    code: >
      (
          $obj_id:= obj_id;
          $ctx:= ctx;

          $entities_id_list:= $arch_objects_entities($ctx);

          $context_content:=  $map($entities_id_list, function($v) {
                                        $map($eval("$ctx" & "." & "\"" & $string($v.entity_id) & "\"").$keys()[$contains($, $obj_id) and 
                                                                                            $substringBefore($, $obj_id) = "" 
                                                                                            ], function($vv) {
                                            
                                            {
                                                "object_id": $vv,
                                                "body": $ctx.$lookup($eval("$ctx" & "." & "\"" & $v.entity_id & "\""), $vv),
                                                "entity_id": $v.entity_id,
                                                "entity_title": $v.entity_title
                                            }
                                        })
                                });
          $context_content:= [$reduce($context_content, $append)];
      )
    result:
      type: array
      description: >
        Перечень объектов контекста {"obj", "entity"}

  context_content_refined:
    title: Содержимое c учетом точки зрения
    params:
      - type: string
        title: Доменный идентификатор
        alias: domain
        required: true
      - type: object
        title: Глобальный контекст ($$)
        alias: ctxG
        required: true

    code: >
      (
            $domain:= domain;
            $ctxG:= ctxG;
            $byCtx:= $byContext($ctxG); 
            
            $isContext:= $byCtx[$.context = $domain]
              ? true
              : false;


            $wrapping_context:= $isContext
                                  ? $byCtx[$domain in $.content.object_id and 
                                                $domain != $.context].context
                                  : $byCtx[$domain in $.content.object_id].context;
            $members:= $isContext
              ? (
                  $members:=  $map($byCtx[$.context = $domain].content, function($v) {
                                $v.object_id in $byCtx.context
                                  ? {"membersCtx": {"id": $v.object_id, "body": $v.body ~> |$|{"entity_id": $v.entity_id, "entity_title": $v.entity_title}|}}
                                  : {"membersOrd": {"id": $v.object_id, "body": $v.body ~> |$|{"entity_id": $v.entity_id, "entity_title": $v.entity_title}|}}
                              });
                  
                  $facades:= $getFacadesImpressed($domain, $byCtx, $ctxG);

                  $facades:= $map($facades, function($v) {
                    {"membersOrd": $v~>|$|{"id": $.object_id, "body": $merge([$.body, {"overriden": $.overriden, "entity_id": $.entity_id, "entity_title": $.entity_title}])}, ["object_id", "overriden", "entity_id", "entity_title"]|}
                  });
                  
                  $members:= $count($facades) > 0
                   ? (/*$facades_enriched:= $map($facades, function($v) {(
                        $members.membersCtx[$.id = $v.object_id]
                          ? {"membersCtx":{"id": $v.object_id, "body": $merge([$.body, $v.body])}}
                          : $members.membersOrd[$.id = $v.object_id]
                              ? {"membersOrd":{"id": $v.object_id, "body": $merge([$.body, $v.body])}}
                              : {"membersOrd": {"id": $v.object_id, "body": $v.body~>|$|{"entity_id": $v.entity_id}|}}
                      )});*/
                      $append($map($members, function($v) {(
                        $not($v.*.id in $facades.membersOrd.id)
                          ? $v
                      )}), $facades);
                      )
                   : $members;
                );
              
            $neighbours:= $map($byCtx[$.context = $wrapping_context].content, function($v) {
                             $v.object_id in $byCtx.context
                                ? {"neighboursCtx": {"id": $v.object_id, "body": $v.body ~> |$|{"entity_id": $v.entity_id}|}}
                                : {"neighboursOrd": {"id": $v.object_id, "body": $v.body ~> |$|{"entity_id": $v.entity_id}|}}
                        });
            
            $facades:= $wrapping_context ? $getFacadesImpressed($wrapping_context, $byCtx, $ctxG);

              $neighbours:= $count($facades) > 0
                   ? ($facades_enriched:= $map($facades, function($v) {(
                        $neighbours.neighboursCtx[$.id = $v.object_id]
                          ? {"neighboursCtx":{"id": $v.object_id, "body": $merge([$.body, $v.body])}}
                          : $neighbours.neighboursOrd[$.id = $v.object_id]
                              ? {"neighboursOrd":{"id": $v.object_id, "body": $merge([$.body, $v.body])}}
                              : {"neighboursOrd": {"id": $v.object_id, "body": $v.body~>|$|{"entity_id": $v.entity_id}|}}
                      )});
                      $append($map($neighbours, function($v) {
                        $not($v.*.id in $facades_enriched.*.id)
                          ? $v
                      }), $facades_enriched);
                      )
                : $neighbours;
            
            {"isContext": $isContext, 
             /*"wrapper": $distinct($byCtx.content[$.object_id = $wrapping_context].{"id": $wrapping_context, "body": $.body}),*/
             "wrapper": $wrapping_context,
             "observable": $append($members, $neighbours)
            }
      )
    result:
      type: object

  getFacadesImpressed:
    title: Найти фасады, выставленные в данный контекст
    params:
      - type: string
        alias: ctx
        required: true
      - type: array
        title: Контексты ограниченные сверху и снизу
        alias: byContext
        required: true
      - type: object
        title: Глобальный контекст ($$)
        alias: ctxG
        required: true
    code: >
      (
        $ctx:= ctx; $byCtx:= byContext; $ctxG:= ctxG;

        $ctx_list:= $seaf_contexts($ctxG).context; 
        $expositions:=  $map($byCtx.content, function($v){(
                          $map($v.body.exposed.$keys($), function($vk) {(
                            $ex:= $map($seaf_ddd_tree($vk).paths, function($vv, $ii, $aa) {(
                                    $path:= $aa[-2 - $ii];
                                    $path in $ctx_list and
                                    $contains($path, $ctx) and
                                    $substringBefore($path, $ctx) = ""
                                      ? [$path]
                                  )});
                            $reduce($ex, $append)[0] = $ctx 
                              ? ( $resident:= $byCtx[$.context = $ctx].content[$.object_id = $vk];

                              $v~>|$.body|$resident? $merge([$eval("$.body.exposed." & "'" & $vk & "'"), {"resident": $resident.body}]) :$eval("$.body.exposed." & "'" & $vk & "'")|)
                          )})
                        )});
        
        $expositions:= $distinct($reduce($expositions, $append));

        $impressed:=[$map($expositions, function($v) {(
                      $k:= $v.body.exposed.$keys()[$contains($, $ctx)];
                      {"object_id": $k, "body": $merge([$merge([$eval("$v.body.exposed." & "'" & $k & "'"), $v.body.resident]), {"impressed": $v.object_id}]), "overriden": $v.body.resident? true : false, "entity_id": $v.entity_id, "entity_title": $v.entity_title}
                    )})];

      )
    result:
      type: array
      description: facades impressed


  seaf_contexts:
    title: Возвращает перечень контекстов (auto + manual) и пути в меню
    params:
      - type: object
        title: Область поиска контекстов (глобальный Контекст -- $$)
        alias: ctx
        required: true
    code: >
      (   
          $ctx:= ctx;

          $parties:= $ctx."seaf.ba.parties";
          $top_domains:= $parties
            ? $seaf_ddd_top($ctx."seaf.ba.parties");                        /*auto top domains discovery goes among parties (main arch entity)*/
          $user_defined:= $ctx."seaf.self" != null                          /*non-top parties and other entities are considered as context if they listed in seaf.self*/
            ? $ctx."seaf.self"[$ in $ctx.*.$keys()];                        
          $contexts_id:= $distinct($append($top_domains, $user_defined ));

          $contexts:= $map($contexts_id, function($v){(
                        $full_paths:= $seaf_ddd_tree($v).paths;

                        $menu_path:= function($arr, $i, $path){(
                          $obj:= $arch_objects($ctx)[$.object_id = $arr[$i]];
                          $not($i > 0)
                            ? $path:= $obj.object_title
                            : $path:= $path & "/" & $obj.object_title;

                          $i < $count($arr)-1
                            ? $menu_path($arr, $i+1, $path)
                            : {"context": $v, "menu_path": $path, "entity_id": $obj.entity_id, "entity_title": $obj.entity_title}
                        )}; $menu_path([$full_paths], 0, "");

                      )});
            [$contexts];
      )
    result:
      type: array
      description: массив объектов {location, link(presentation)}

  seaf_ddd_tree:
    title: Получение дерева DDD из идентификатора объекта
    params:
      - type: string
        title: Идентификатор объекта
        alias: obj_id
        required: true
    code: >
      (
          $obj_id:= obj_id;

          $getDDDWrappers:= function($obj_id){(
            $domains:= $split($obj_id, ".");
            $domains:= $count($domains) > 0
              ? $domains
              : [];
            $getPaths:= function($domains, $i, $paths){(
              $paths:= $i=0
                        ? $domains[0]
                        : $append($paths, $paths[$i-1] & "." & $domains[$i]);
              $i < $count($domains)-1 
                ? $getPaths($domains, $i+1, $paths)
                : $paths 
            )};
            $paths:= $getPaths($domains, 0, []);
            
            { 
              "domains": [$domains],  /*includes $obj_id tail*/
              "paths": [$paths]       /*includes $obj_id itself*/
            }
          )};

          $getDDDWrappers($obj_id);
      )
    result:
      type: object
      description: >
        domains -- массив идентификаторов доменов (d1, d2, ...), 
        paths -- массив "путей" (d1, d1.d2, ...)

  seaf_ddd_top:
    title: Получение DDD верхнего уровня
    params:
      - type: object
        title: Объекты сущности
        alias: objects
    code: >
      (
        $ctxG:= ctxG;
        $objects:= objects.$spread();
        $tops:= $map($objects, function($v) {(
                  $paths:= $seaf_ddd_tree($v.$keys()).paths;

                  $getTop:= function($paths, $i){(
                    $paths[$i] in $objects.$keys()
                      ? $paths[$i]
                      : $getTop($paths, $i+1)
                  )};

                  $top:= $getTop($paths, 0);
                )});

        [$distinct($tops)]        
      )
    result:
      type: array
      description: Верхние DDD домены

  seaf_has_parts:
    title: Из каких частей состоит объект
    params:
      - type: string
        title: Идентификатор объекта
        alias: obj_id
        required: true
      - type: object
        title: Глобальный Контекст -- $$
        alias: ctx
        required: true
    code: >
      (
          $ctx:= ctx;
          $obj_id:= obj_id;

            $getParts:= function($obj_id, $i, $parts_id){(
                            $parts:= $ctx.*.$spread()[$obj_id = $.*.is_part_of].$keys();
                            $count($parts) > 0
                              ? (
                                  $parts:= $map($parts, function($v){(
                                   {$string($obj_id): $v}
                                  )});
                                  $parts_id:=$append($parts_id, $parts);
                                  $deeper:= $map($parts, function($v) {(
                                    $getParts($v.*, $i+1, $parts_id)
                                  )});
                                  $parts_id:= $reduce($append($parts_id, $deeper), $append)
                                )
                              : $parts_id
                        )};
            $parts:= $getParts($obj_id, 0, []);
            $count($parts) > 0 
              ? [$distinct($parts)]
              : []
      )
    result:
      type: array
      description: >
        Перечень идентификаторов сверху вниз

  seaf_is_part:
    title: Часть чего является объект
    params:
      - type: string
        title: Идентификатор объекта
        alias: obj_id
        required: true
      - type: object
        title: Глобальный Контекст -- $$
        alias: ctx
        required: true
    code: >
      (
          $ctx:= ctx;
          $obj_id:= obj_id;

            $getWrappers:= function($obj_id, $wrappers_id){(
              $obj:= $ctx.*.$spread()[$.$keys() = $obj_id];
              $wrapper:= $obj.*.is_part_of;
              $res:= $wrapper
                ? ($wrappers_id:= $append($wrappers_id, $obj.*.is_part_of);
                  $getWrappers($wrapper, $wrappers_id))
                : $wrappers_id
            )};
            $wrappers:= $getWrappers($obj_id, [])^(<$length($));
            $count($wrappers) > 0 
              ?[$wrappers]
              : []
      )
    result:
      type: array
      description: >
        Перечень идентификаторов сверху вниз, не включая сам объект

